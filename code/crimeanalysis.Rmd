---
title: "crime_analysis"
author: "Shannon Wongvibulsin"
date: "September 11, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Johns Hopkins Security Alert - Crime Analysis & Visualization

## Introduction

Baltimore City consistently ranks as one of the most dangerous cities in America. As a result, discussion about safety concerns at Johns Hopkins is common. To promote a safe and secure environment, the Hopkins Corporate Security provides the University and Hospital communities proactive security and law enforcement practices. Corporate Security maintains a record of the campus crime and provides annual crime statistics. 

The Hopkins Corporate Security Crime Log represents a rich source of crime data that can be analyzed for crime patterns. A recent article in PLOS|ONE reported that most crimes exhibit seasonal oscillations (Dong, PLOS|ONE, 2017). The Hopkins Security crime log can be used to determine whether certain types of crime occur more frequently at certain locations, times of day, days of the week, or times of the year at the Hopkins East Baltimore Medical Campus. Furthermore, understanding these patterns can help with crime projections to increase campus safety through crime prevention activities (Andresen, Applied Geography, 2013). For example, increased security personnel can be strategically positioned based upon crime patterns. Additionally, although Corporate Security notifies Hopkins of reported crimes that present a “serious or continuing threat” through “Security Alert” emails, detailed analysis of crime patterns can allow Corporate Security to inform the community about general crime “forecasts” as well as general safety precaution recommendations. To present this analysis in a useful and interactive format, this project involves not only the analysis of the Hopkins crime data but also the development of a Shiny App for interactive analysis and visualization. 

Overall, the goal of the project is to provide a better understanding of the crime patterns at the Hopkins East Baltimore Campus through the analysis of trends in crime and the development of an application for interactive analysis and visualization.


## Methods

The 2015, 2016, and 2017 Hopkins Crime Logs were obtained from the Johns Hopkins University Clery Compliance Administrator. The data logs were provided in tables in the PDF format. The tables were converted into the Excel spreadsheet using PDFTables (https://pdftables.com/). Afterwards, the spreadsheets were saved in CSV formats and loaded into R for further analysis. 

Histograms are plotted using R to visually compare the frequency of different types of crimes in different years, seasons, months, and days of week. The data will be analyzed by month, season, and day of week to determine if there are temporal variations in crime patterns.

For interactive analysis and visualization, a Johns Hopkins East Baltimore Crime Shiny Application is built using R.

references:
http://wtop.com/local/2016/02/d-c-baltimore-city-among-most-dangerous-places-in-u-s/
https://www.forbes.com/pictures/mlj45jggj/7-baltimore/#68a81b8b5487
http://baltimore.cbslocal.com/2017/06/16/baltimore-ranks-on-new-list-of-worst-american-cities-to-live-in/ 
http://www.hopkinsmedicine.org/security_parking_transportation/security/
http://security.jhu.edu/_template-assets/documents/annual_report.pdf

## Inport Data
Data from Johns Hopkins University Clery Compliance Administrator after conversion to CSV formats.

```{r data}
setwd("/Users/purplesw/Dropbox/final_project/data")
dat.15 <- read.csv("2015crimelog.csv")
dat.16 <- read.csv("2016crimelog.csv")
dat.17 <- read.csv("2017crimelog.csv")
```

## Differences in crime types in different years
```{r}
unique(dat.15$Crime)
unique(dat.16$Crime)
unique(dat.17$Crime)
```


## Create plots
```{r}

t15 <- table(dat.15$Crime)
d15 <- as.data.frame(t15)
d15$Yr <- "15"
  
t16 <- table(dat.16$Crime)
d16 <- as.data.frame(t16)
d16$Yr <- "16"

t17 <- table(dat.17$Crime)
d17 <- as.data.frame(t17)
d17$Yr <- "17"

total <- rbind(d15, d16)
total <- rbind(total, d17)


library(ggplot2)
library(plotly)

p <- ggplot(data = total, aes(x=Var1, y=Freq, fill = Yr)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + labs(title = "Crime Frequency by Year", x = "Crime Type", y = "Number of Incidents")

pp <- ggplotly(p) 

pp


```

## Dates
consider season, month, day of week, time

```{r}
library(lubridate)
library(dplyr)
library(reshape2)

#dat.15$day <- weekdays(as.Date(dat.15$Date.Time.Reported))
#dat.15$month <- months(as.Date(dat.15$Date.Time.Reported))
#dat.15$quarter <- quarters(as.Date(dat.15$Date.Time.Reported))

# extract time information from Date.Time.Occurred; if strsplit(as.character(x), " ")[[1]][3]  == "PM", add 12 hours except  

dat.15$timehour <- sapply(dat.15$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][2]) 
dat.15$timeap <- sapply(dat.15$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][3])

#dat.15$timeday[dat.15$timehour]

dat.15$date <- sapply(dat.15$Date.Time.Reported, function(x) strsplit(as.character(x), " ")[[1]][1]) %>% mdy()
dat.15$day <- weekdays(dat.15$date)
dat.15$month <- months(dat.15$date)
dat.15$quarter <- quarters(dat.15$date)

dat.15 <- dat.15[-288,]

dw15 <- as.data.frame(table(dat.15$Crime, dat.15$day))

dwm15 <- melt(dw15, c("Var1", "Var2"))

pd <- ggplot(data = dwm15, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

ppd <- ggplotly(pd) 

ppd

dw15m <- as.data.frame(table(dat.15$Crime, dat.15$month))

dwm15m <- melt(dw15m, c("Var1", "Var2"))

pm <- ggplot(data = dwm15m, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

ppm <- ggplotly(pm) 

ppm

dw15q <- as.data.frame(table(dat.15$Crime, dat.15$quarter))

dwm15q <- melt(dw15q, c("Var1", "Var2"))

pq <- ggplot(data = dwm15q, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

ppq <- ggplotly(pq) 

ppq

# seasons

newdat.15$num.month <- match(newdat.15$month, month.name)

newdat.15 <-
newdat.15 %>%
  mutate(Season = ifelse(num.month >= 3 & num.month <= 5, "Spring", 
                          ifelse(num.month >= 6 & num.month <= 8, "Summer",
                            ifelse(num.month >= 9 & num.month <= 11, "Autumn", "Winter"))))

dw15s <- as.data.frame(table(newdat.15$Crime, newdat.15$Season))

dwm15s <- melt(dw15s, c("Var1", "Var2"))

ps <- ggplot(data = dwm15s, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

pps <- ggplotly(ps) 

pps

```

## Location
Need to do text processing of general locations (buildings, areas)
155 unique locations 
look at groupings of general areas
look at correlations of crime types, time and areas
```{r}
t.15 <- table(dat.15$General.Location)
d.15 <- as.data.frame(t.15)

library("dataframes2xls")
write.xls(d.15, "locationlist.xls")

library("stringr")
d.15$outside <- str_detect(d.15$Var1, "block")

```

## To Do
- parse time of day from "Date.Time.Occurred"
- rearrange labels for plots
- add title and axis lables to plots


## Testing tabulizer package

```{r}

library(tabulizer)
library(dplyr)
location <- 'http://www.hopkinsmedicine.org/security_parking_transportation/_downloads/2017.60%20day%20Crime%20Log.pdf'
destfile = "mypdf.pdf"
dl = download.file(location, destfile)
out <- extract_tables(destfile)

library(tabulizer)
library(dplyr)
# Location of WARN notice pdf file
location <- 'http://www.edd.ca.gov/jobs_and_training/warn/WARN-Report-for-7-1-2016-to-10-25-2016.pdf'

# Extract the table
out <- extract_tables(location)


shinyUI(fluidPage(
  title = "Johns Hopkins East Baltimore Medical Campus Crime Analysis"
  br(),
  img(src = "http://www.hopkinsmedicine.org/sebin/j/b/SOM_logo2x.png", height = 100, width = 200)
  fluidRow(
    column(3,
           dateRangeInput(inputId = "date_time",
                          label = "Choose Date Range",
                          start = "2015-01-01",
                          end = "2017-09-01"
  )
),
column(8,
       )
  )
  
))
```



## shiny
```{r}
library(shiny)



shinyUI(fluidPage(
 
  title = "Johns Hopkins East Baltimore Medical Campus Crime Analysis",
  br(),
  img(src = "http://www.hopkinsmedicine.org/sebin/j/b/SOM_logo2x.png", height = 100, width = 200),
  fluidRow(
    column(3,
      dateRangeInput(inputId = "date_time",  
                   label = "Choose Date Range", 
                   start = "2015-01-01",
                   end = "2017-09-01"
     )
    ),    
    column(8, 
      h3("Hopkins Crime Dataset Analysis"),
      tabsetPanel( 
      tabPanel("Summary", h4(verbatimTextOutput("dim")), h4("Structure of Dataset"), verbatimTextOutput("structure"), h4("Summary of Dataset"), verbatimTextOutput("summary"), h4("Crime Categories"), verbatimTextOutput("categoryTable"))
      )
    )
  )
)
)

```

