---
title: "crime_analysis"
author: "Shannon Wongvibulsin"
date: "September 11, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Johns Hopkins Security Alert - Crime Analysis & Visualization

## Inport Data
Data from Johns Hopkins University Clery Compliance Administrator after conversion to CSV formats.

```{r data}
#setwd("/Users/purplesw/Dropbox/final_project/data")
#setwd("~/final_project/data")
setwd("./data")
dat.15 <- read.csv("2015crimelog.csv", stringsAsFactor = FALSE)
dat.16 <- read.csv("2016crimelog.csv", stringsAsFactor = FALSE)
dat.17 <- read.csv("2017crimelog.csv", stringsAsFactor = FALSE)

str(dat.15)
str(dat.16)
str(dat.17)



```

## Differences in crime types in different years
```{r}
unique(dat.15$Crime)
unique(dat.16$Crime)
unique(dat.17$Crime)
```

## Load Necessary Libraries
Note: use ‘ggplot2’ 2.2.0 (add note to readme file)
```{r}
packages<-c("lubridate", "dplyr","ggplot2","reshape2","ggmap", "xtable")

for (i in packages){
  if(!require(i,character.only = T,quietly=T,warn.conflicts = F)){
    install.packages(i)
  }
  require(i,character.only = T,quietly=T,warn.conflicts = F)
}

library(lubridate)
library(dplyr)
library(ggplot2)
library(reshape2)
library(ggmap)
library(xtable)
library(chron)
library(magrittr)

```

## Format data 
create time of day, day of week, month, season, year, inside (outside), location
```{r}
# remove blank entries
dat.15 <- dat.15[!dat.15$Crime == "",]

dat.15$time <- sapply(dat.15$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][2]) #time without AM, PM
dat.15$ap <- sapply(dat.15$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][3]) # AM, PM


dat.15$timeap <- paste(dat.15$time, dat.15$ap) # combine time and AM, PM
# convert to military time
dat.15$mtime <- substr(strptime(dat.15$timeap, "%I:%M %p"), 11,19) 
# remove white space
dat.15$mtime <- trimws(dat.15$mtime)
# extract hour information
dat.15$hours <- as.numeric(substr(dat.15$mtime, 1,2))

dat.15$ctime <- hour(hms(dat.15$mtime)) 
#dat.15$ttimes <- times(dat.15$mtime) 
# categorize times into time of day (tod)
tbreaks <- hour(hm("00:00", "5:00", "11:00", "17:00", "23:59"))
tlabels <- c("Night", "Morning", "Afternoon", "Evening")
#dat.15$tod <- cut(x=dat.15$ttime, breaks = tbreaks, labels = tlabels, include.lowest = TRUE)
dat.15$tod <- cut(x=dat.15$ctime, breaks = tbreaks, labels = tlabels, include.lowest = TRUE)

# date, day, month, quarter
dat.15$date <- sapply(dat.15$Date.Time.Reported, function(x) strsplit(as.character(x), " ")[[1]][1]) %>% mdy()
dat.15$day <- weekdays(dat.15$date)
dat.15$day <- factor(dat.15$day, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

dat.15$month <- months(dat.15$date)
dat.15$month <- factor(dat.15$month, levels = month.name)
dat.15$quarter <- quarters(dat.15$date)

# seasons

dat.15$num.month <- match(dat.15$month, month.name)

dat.15 <-
dat.15 %>%
  mutate(season = ifelse(num.month >= 3 & num.month <= 5, "Spring", 
                          ifelse(num.month >= 6 & num.month <= 8, "Summer",
                            ifelse(num.month >= 9 & num.month <= 11, "Autumn", "Winter"))))

dat.15$season <- factor(dat.15$season, levels = c("Spring", "Summer", "Autumn", "Winter"))


# table crimes by tod
crime.tod.15 <- as.data.frame(table(dat.15$Crime, dat.15$tod))

#dh15m <- dat.15 %>% filter() add filtering statements

# create function for summarizing total crime vs. variable of interest

# TO DO: Add Axis Labels and Title
crime.sum <- function(df, x){
  dft <- as.data.frame(table(df$Crime, df[,x]))
  dft <- melt(dft, c("Var1", "Var2"))
  g.dft <- dft %>% group_by(Var2) %>% summarize(n = sum(value))
  dg.dft <- as.data.frame(g.dft)
  
  p <- ggplot(data = dg.dft, aes(x=Var2, y=n)) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + stat_smooth((aes(group = 1)), se = FALSE)
  return(p)
  
}


crime.sum.yr <- function(df15, df16, g.dft.17, x){
  dft.15 <- as.data.frame(table(df15$Crime, df15[,x]))
  dft.16 <- as.data.frame(table(df16$Crime, df16[,x]))
  #dft.17 <- as.data.frame(table(df17$Crime, df17[,x]))
  dft.15 <- melt(dft.15, c("Var1", "Var2"))
  dft.16 <- melt(dft.16, c("Var1", "Var2"))
  #dft.17 <- melt(dft.17, c("Var1", "Var2"))
  g.dft.15 <- dft.15 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.16 <- dft.16 %>% group_by(Var2) %>% summarize(n = sum(value))
  #g.dft.17 <- dft.17 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.15 <- g.dft.15 %>% mutate(year = 2015)
  g.dft.16 <- g.dft.16 %>% mutate(year = 2016)
  #g.dft.17 <- g.dft.17 %>% mutate(year = 2017)
  dg.dft.15 <- as.data.frame(g.dft.15)
  dg.dft.16 <- as.data.frame(g.dft.16)
  #dg.dft.17 <- as.data.frame(g.dft.17)
  m.df <- rbind(g.dft.15, g.dft.16)
  m.df <- rbind(m.df, g.dft.17)
  
  p <- ggplot(data = m.df, aes(x=Var2, y=n, group = factor(year), color = factor(year))) + stat_smooth(se = FALSE) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = c(0.8,0.9), legend.title = element_blank()) + ylab("Crime Count") + xlab(NULL) + ggtitle("Total Crime by Month")
  return(p)
  
}

crime.h <- function(df15, df16, df17, x){
  dft.15 <- as.data.frame(table(df15$Crime, df15[,x]))
  dft.16 <- as.data.frame(table(df16$Crime, df16[,x]))
  dft.17 <- as.data.frame(table(df17$Crime, df17[,x]))
  dft.15 <- melt(dft.15, c("Var1", "Var2"))
  dft.16 <- melt(dft.16, c("Var1", "Var2"))
  dft.17 <- melt(dft.17, c("Var1", "Var2"))
  g.dft.15 <- dft.15 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.16 <- dft.16 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.17 <- dft.17 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.15 <- g.dft.15 %>% mutate(year = 2015)
  g.dft.16 <- g.dft.16 %>% mutate(year = 2016)
  g.dft.17 <- g.dft.17 %>% mutate(year = 2017)
  dg.dft.15 <- as.data.frame(g.dft.15)
  dg.dft.16 <- as.data.frame(g.dft.16)
  dg.dft.17 <- as.data.frame(g.dft.17)
  m.df <- rbind(g.dft.15, g.dft.16)
  m.df <- rbind(m.df, g.dft.17)
  
  p <- ggplot(data = m.df, aes(x=Var2, y=n, group = factor(year), color = factor(year))) + stat_smooth(se = FALSE) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = c(0.8,0.9), legend.title = element_blank()) + ylab("Crime Count") + xlab("Hours in Military Time") + ggtitle("Total Crime by Hour")
  return(p)
  
}


crime.t <- function(df15, df16, df17, x){
  dft.15 <- as.data.frame(table(df15$Crime, df15[,x]))
  dft.16 <- as.data.frame(table(df16$Crime, df16[,x]))
  dft.17 <- as.data.frame(table(df17$Crime, df17[,x]))
  dft.15 <- melt(dft.15, c("Var1", "Var2"))
  dft.16 <- melt(dft.16, c("Var1", "Var2"))
  dft.17 <- melt(dft.17, c("Var1", "Var2"))
  g.dft.15 <- dft.15 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.16 <- dft.16 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.17 <- dft.17 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.15 <- g.dft.15 %>% mutate(year = 2015)
  g.dft.16 <- g.dft.16 %>% mutate(year = 2016)
  g.dft.17 <- g.dft.17 %>% mutate(year = 2017)
  dg.dft.15 <- as.data.frame(g.dft.15)
  dg.dft.16 <- as.data.frame(g.dft.16)
  dg.dft.17 <- as.data.frame(g.dft.17)
  m.df <- rbind(g.dft.15, g.dft.16)
  m.df <- rbind(m.df, g.dft.17)
  
  p <- ggplot(data = m.df, aes(x=Var2, y=n, group = factor(year), color = factor(year))) + stat_smooth(se = FALSE) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = c(0.8,0.9), legend.title = element_blank()) + ylab("Crime Count") + xlab(NULL) + ggtitle("Total Crime by Time of Day")
  return(p)
  
}

crime.d <- function(df15, df16, df17, x){
  dft.15 <- as.data.frame(table(df15$Crime, df15[,x]))
  dft.16 <- as.data.frame(table(df16$Crime, df16[,x]))
  dft.17 <- as.data.frame(table(df17$Crime, df17[,x]))
  dft.15 <- melt(dft.15, c("Var1", "Var2"))
  dft.16 <- melt(dft.16, c("Var1", "Var2"))
  dft.17 <- melt(dft.17, c("Var1", "Var2"))
  g.dft.15 <- dft.15 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.16 <- dft.16 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.17 <- dft.17 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.15 <- g.dft.15 %>% mutate(year = 2015)
  g.dft.16 <- g.dft.16 %>% mutate(year = 2016)
  g.dft.17 <- g.dft.17 %>% mutate(year = 2017)
  dg.dft.15 <- as.data.frame(g.dft.15)
  dg.dft.16 <- as.data.frame(g.dft.16)
  dg.dft.17 <- as.data.frame(g.dft.17)
  m.df <- rbind(g.dft.15, g.dft.16)
  m.df <- rbind(m.df, g.dft.17)
  
  p <- ggplot(data = m.df, aes(x=Var2, y=n, group = factor(year), color = factor(year))) + stat_smooth(se = FALSE) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = c(0.8,0.9), legend.title = element_blank()) + ylab("Crime Count") + xlab(NULL) + ggtitle("Total Crime by Day")
  return(p)
  
}

dcrime <- crime.d(dat.15, dat.16, dat.17, "day")
tcrime <- crime.t(dat.15, dat.16, dat.17, "tod")
hcrime <- crime.h(dat.15, dat.16, dat.17, "hours")
mcrime <- crime.sum.yr(dat.15, dat.16, dg.dft.17, "month")

plot_grid(mcrime, dcrime, hcrime, tcrime, labels = c("A", "B", "C", "D"))

#theme(axis.text.x = element_text(angle = 90, hjust = 1))


  dft.15 <- as.data.frame(table(dat.15$Crime, dat.15[,"month"]))
  dft.16 <- as.data.frame(table(dat.16$Crime, dat.16[,"month"]))
  dft.15 <- melt(dft.15, c("Var1", "Var2"))
  dft.16 <- melt(dft.16, c("Var1", "Var2"))
  g.dft.15 <- dft.15 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.16 <- dft.16 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.15 <- g.dft.15 %>% mutate(year = 2015)
  g.dft.16 <- g.dft.16 %>% mutate(year = 2016)
  dg.dft.15 <- as.data.frame(g.dft.15)
  dg.dft.16 <- as.data.frame(g.dft.16)
  m.df <- rbind(dg.dft.15, dg.dft.16)
  #m.df <- left_join(g.dft.15, g.dft.16, by = "Var2")

  p <- ggplot(data = m.df, aes(x=Var2, y=n, color = factor(year))) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + stat_smooth((aes(group = 2)),se = FALSE) + theme_classic()

ggplot(data = m.df, aes(x=Var2, y=n, color = year)) + geom_point()

p <- ggplot(data = m.df, aes(x=Var2, y=n, group = factor(year), color = factor(year))) + geom_smooth(se = FALSE) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

crime.sum.yr(dat.15, dat.16, "month") # need to end 2017 data in August (last complete month of data collection)

crime.sum(dat.15, "hours")
crime.sum(dat.15, "tod")
crime.sum(dat.15, "day")
crime.sum(dat.15, "month")

#crime.sum(dat.15, "season")

#dh15 <- as.data.frame(table(dat.15$Crime, dat.15$hours))
#dh15 <- melt(dh15, c("Var1", "Var2"))
#g.dh15 <- dh15 %>% group_by(Var2) %>% summarise(n = sum(value))
#dg.dh15 <- as.data.frame(g.dh15) 

#dg.dh15$Var2 <- factor(dg.dh15$Var2)

#dg.dwm15[order(dg.dwm15$Var2),]
# plot by hour
#plot.dh15 <- ggplot(data = dg.dh15, aes(x=Var2, y=n)) + theme(axis.text.x = #element_text(angle = 90, hjust = 1)) + geom_line((aes(group = 1)))


# 2016 data
# remove blank entries
dat.16 <- dat.16[!dat.16$Crime == "",]
dat.16 <- dat.16[!dat.16$Crime == "21",]

dat.16$time <- sapply(dat.16$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][2]) #time without AM, PM
dat.16$ap <- sapply(dat.16$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][3]) # AM, PM
dat.16$timeap <- paste(dat.16$time, dat.16$ap) # combine time and AM, PM
# convert to military time
dat.16$mtime <- substr(strptime(dat.16$timeap, "%I:%M %p"), 11,19) 
# remove white space
dat.16$mtime <- trimws(dat.16$mtime)
dat.16$hours <- as.numeric(substr(dat.16$mtime, 1,2))

dat.16$ctime <- hour(hms(dat.16$mtime)) 
#dat.15$ttimes <- times(dat.15$mtime) 
# categorize times into time of day (tod)
tbreaks <- hour(hm("00:00", "5:00", "11:00", "17:00", "23:59"))
tlabels <- c("Night", "Morning", "Afternoon", "Evening")
#dat.15$tod <- cut(x=dat.15$ttime, breaks = tbreaks, labels = tlabels, include.lowest = TRUE)
dat.16$tod <- cut(x=dat.16$ctime, breaks = tbreaks, labels = tlabels, include.lowest = TRUE)

# table crimes by tod
crime.tod.16 <- as.data.frame(table(dat.16$Crime, dat.16$tod))

# date, day, month, quarter
dat.16$date <- sapply(dat.16$Date.Time.Reported, function(x) strsplit(as.character(x), " ")[[1]][1]) %>% mdy()
dat.16$day <- weekdays(dat.16$date)
dat.16$day <- factor(dat.16$day, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

dat.16$month <- months(dat.16$date)
dat.16$month <- factor(dat.16$month, levels = month.name)
dat.16$quarter <- quarters(dat.16$date)

dat.16$num.month <- match(dat.16$month, month.name)

dat.16 <-
dat.16 %>%
  mutate(season = ifelse(num.month >= 3 & num.month <= 5, "Spring", 
                          ifelse(num.month >= 6 & num.month <= 8, "Summer",
                            ifelse(num.month >= 9 & num.month <= 11, "Autumn", "Winter"))))

dat.16$season <- factor(dat.16$season, levels = c("Spring", "Summer", "Autumn", "Winter"))

# 2017 data
dat.17 <- dat.17[!dat.17$Crime == "",]
dat.17 <- dat.17[!dat.17$Crime == "18",]

dat.17$time <- sapply(dat.17$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][2]) #time without AM, PM
dat.17$ap <- sapply(dat.17$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][3]) # AM, PM


dat.17$timeap <- paste(dat.17$time, dat.17$ap) # combine time and AM, PM
# convert to military time
dat.17$mtime <- substr(strptime(dat.17$timeap, "%I:%M %p"), 11,19) 
# remove white space
dat.17$mtime <- trimws(dat.17$mtime)
dat.17$hours <- as.numeric(substr(dat.17$mtime, 1,2))


dat.17$ctime <- hour(hms(dat.17$mtime)) 
#dat.15$ttimes <- times(dat.15$mtime) 
# categorize times into time of day (tod)
tbreaks <- hour(hm("00:00", "5:00", "11:00", "17:00", "23:59"))
tlabels <- c("Night", "Morning", "Afternoon", "Evening")
#dat.15$tod <- cut(x=dat.15$ttime, breaks = tbreaks, labels = tlabels, include.lowest = TRUE)
dat.17$tod <- cut(x=dat.17$ctime, breaks = tbreaks, labels = tlabels, include.lowest = TRUE)

# table crimes by tod
crime.tod.17 <- as.data.frame(table(dat.17$Crime, dat.17$tod))

# date, day, month, quarter
dat.17$date <- sapply(dat.17$Date.Time.Reported, function(x) strsplit(as.character(x), " ")[[1]][1]) %>% mdy()
dat.17$day <- weekdays(dat.17$date)
dat.17$day <- factor(dat.17$day, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

dat.17$month <- months(dat.17$date)
dat.17$month <- factor(dat.17$month, levels = month.name)
dat.17$quarter <- quarters(dat.17$date)



# date, day, month, quarter
#dat.15$date <- sapply(dat.15$Date.Time.Reported, function(x) strsplit(as.character(x), " ")[[1]][1]) %>% mdy()
#dat.15$day <- weekdays(dat.15$date)
#dat.15$month <- months(dat.15$date)
#dat.15$quarter <- quarters(dat.15$date)

dw15 <- as.data.frame(table(dat.15$Crime, dat.15$day))
dwm15 <- melt(dw15, c("Var1", "Var2"))
g.dwm15 <- dwm15 %>% group_by(Var2) %>% summarise(n = sum(value))
dg.dwm15 <- as.data.frame(g.dwm15) 
dg.dwm15$Var2 <- factor(dg.dwm15$Var2, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))


dw15 <- as.data.frame(table(dat.15$Crime, dat.15$day))
dwm15 <- melt(dw15, c("Var1", "Var2"))
dwm15.a <- dwm15 %>% filter(Var1 == "Assault")
g.dwm15.a <- dwm15.a %>% group_by(Var2) %>% summarise(n = sum(value))
dg.dwm15.a <- as.data.frame(g.dwm15.a) 
dg.dwm15.a$Var2 <- factor(dg.dwm15.a$Var2, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))


dw16 <- as.data.frame(table(dat.16$Crime, dat.16$day))
dwm16 <- melt(dw15, c("Var1", "Var2"))
dwm16.a <- dwm16 %>% filter(Var1 == "Assault")
g.dwm16.a <- dwm16.a %>% group_by(Var2) %>% summarise(n = sum(value))
dg.dwm16.a <- as.data.frame(g.dwm16.a) 
dg.dwm16.a$Var2 <- factor(dg.dwm16.a$Var2, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

dw17 <- as.data.frame(table(dat.17$Crime, dat.17$day))
dwm17 <- melt(dw17, c("Var1", "Var2"))
dwm17.a <- dwm17 %>% filter(Var1 == "Assault")
g.dwm17.a <- dwm17.a %>% group_by(Var2) %>% summarise(n = sum(value))
dg.dwm17.a <- as.data.frame(g.dwm17.a) 
dg.dwm17.a$Var2 <- factor(dg.dwm17.a$Var2, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

dg.dwm15.a <- dg.dwm15.a %>% mutate(year = 2015)
dg.dwm16.a <- dg.dwm15.a %>% mutate(year = 2016)
dg.dwm17.a <- dg.dwm15.a %>% mutate(year = 2017)

m.df <- rbind(dg.dwm15.a, dg.dwm16.a)
m.df <- rbind(m.df, dg.dwm17.a)

# plot not plotting 3 lines
p <- ggplot(data = m.df, aes(x=Var2, y=n, group = factor(year), color = factor(year))) + stat_smooth(se = FALSE) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = c(0.8,0.9), legend.title = element_blank()) + ylab("Assault Count") + xlab(NULL) + ggtitle("Total Assaults by Day")


ggplot(data = dg.dwm15.a, aes(x=Var2, y=n)) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + geom_smooth(color = "black")



#dg.dwm15[order(dg.dwm15$Var2),]

#plot.d15 <- ggplot(data = dg.dwm15, aes(x=Var2, y=n)) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + geom_line((aes(group = 1)))


# create 1 dataframe, label by years, overlay plots

# filter by crime type and then plot by another variable of interest


crime.a <- function(df15, df16, df17, var, x){
  dft.15 <- as.data.frame(table(df15$Crime == var, df15[,x]))
  dft.16 <- as.data.frame(table(df16$Crime == var, df16[,x]))
  dft.17 <- as.data.frame(table(df17$Crime == var, df17[,x]))
  dft.15 <- melt(dft.15, c("Var1", "Var2"))
  dft.16 <- melt(dft.16, c("Var1", "Var2"))
  dft.17 <- melt(dft.17, c("Var1", "Var2"))
  g.dft.15 <- dft.15 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.16 <- dft.16 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.17 <- dft.17 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.15 <- g.dft.15 %>% mutate(year = 2015)
  g.dft.16 <- g.dft.16 %>% mutate(year = 2016)
  g.dft.17 <- g.dft.17 %>% mutate(year = 2017)
  dg.dft.15 <- as.data.frame(g.dft.15)
  dg.dft.16 <- as.data.frame(g.dft.16)
  dg.dft.17 <- as.data.frame(g.dft.17)
  m.df <- rbind(g.dft.15, g.dft.16)
  m.df <- rbind(m.df, g.dft.17)
  
  p <- ggplot(data = m.df, aes(x=Var2, y=n, group = factor(year), color = factor(year))) + stat_smooth(se = FALSE) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = c(0.8,0.9), legend.title = element_blank()) + ylab("Assault Count") + xlab(NULL) + ggtitle("Total Assaults by Day")
  return(p)
  
}

crime.th <- function(df15, df16, df17, var, x){
  dft.15 <- as.data.frame(table(df15$Crime == var, df15[,x]))
  dft.16 <- as.data.frame(table(df16$Crime == var, df16[,x]))
  dft.17 <- as.data.frame(table(df17$Crime == var, df17[,x]))
  dft.15 <- melt(dft.15, c("Var1", "Var2"))
  dft.16 <- melt(dft.16, c("Var1", "Var2"))
  dft.17 <- melt(dft.17, c("Var1", "Var2"))
  g.dft.15 <- dft.15 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.16 <- dft.16 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.17 <- dft.17 %>% group_by(Var2) %>% summarize(n = sum(value))
  g.dft.15 <- g.dft.15 %>% mutate(year = 2015)
  g.dft.16 <- g.dft.16 %>% mutate(year = 2016)
  g.dft.17 <- g.dft.17 %>% mutate(year = 2017)
  dg.dft.15 <- as.data.frame(g.dft.15)
  dg.dft.16 <- as.data.frame(g.dft.16)
  dg.dft.17 <- as.data.frame(g.dft.17)
  m.df <- rbind(g.dft.15, g.dft.16)
  m.df <- rbind(m.df, g.dft.17)
  
  p <- ggplot(data = m.df, aes(x=Var2, y=n, group = factor(year), color = factor(year))) + stat_smooth(se = FALSE) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = c(0.8,0.9), legend.title = element_blank()) + ylab("Theft Count") + xlab(NULL) + ggtitle("Total Thefts by Day")
  return(p)
  
}


dft.15 <- dat.15 %>% filter(Crime == "Assault") 
t.15 <- table(dft.15$day)
df.15 <- as.data.frame(t.15)
df.15 <- t(df.15)

dft.15 <- as.data.frame(table(dat.15$Crime == "Assault", dat.15[,"day"]))
dft.16 <- as.data.frame(table(dat.16$Crime == "Assault", dat.16[,"day"]))
dft.17 <- as.data.frame(table(dat.17$Crime == "Assault", dat.17[,"day"]))

acrime <- crime.a(dat.15, dat.16, dat.17, "Assault", "day")
thcrime <- crime.th(dat.15, dat.16, dat.17, "Theft", "day")

plot_grid(acrime, thcrime, labels = c("A", "B"))

dwm15.a <- dwm15[dwm15$Var1== "Assault",]
dwm15.ad <- dwm15.a %>% group_by(Var2) %>% summarise(n = sum(value))
d.dwm15.ad <- as.data.frame(dwm15.ad) 
d.dwm15.ad$Var2 <- factor(d.dwm15.ad$Var2, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))
d.dwm15.ad <- d.dwm15.ad[order(d.dwm15.ad$Var2),]

plot.a15 <- ggplot(data = d.dwm15.ad, aes(x=Var2, y=n)) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + geom_line((aes(group = 1)))

dwm15.s <- dwm15[dwm15$Var1== "Assault" | dwm15$Var1== "Theft", ]


dw15m <- as.data.frame(table(dat.15$Crime, dat.15$month))
dwm15m <- melt(dw15m, c("Var1", "Var2"))
g.dwm15m <- dwm15m %>% group_by(Var2) %>% summarise(n = sum(value))

dg.dwm15m <- as.data.frame(g.dwm15m) 
dg.dwm15m$Var2 <- factor(dg.dwm15m$Var2, levels = month.name)
#dwm15m.s <- dwm15m[dwm15m$Var1== "Assault" | dwm15m$Var1== "Theft", ]

#pm <- ggplot(data = dwm15m, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

plot.m15 <- ggplot(data = dg.dwm15m, aes(x=Var2, y=n)) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + geom_line((aes(group = 1))) + geom_smooth((aes(group = 1)))


#2016
dat.16$date <- sapply(dat.16$Date.Time.Reported, function(x) strsplit(as.character(x), " ")[[1]][1]) %>% mdy()
dat.16$day <- weekdays(dat.16$date)
dat.16$month <- months(dat.16$date)
dat.16$quarter <- quarters(dat.16$date)
dw16 <- as.data.frame(table(dat.16$Crime, dat.16$day))
dwm16 <- melt(dw16, c("Var1", "Var2"))
dwm16.s <- dwm16[dwm16$Var1== "Assault" | dwm16$Var1== "Theft", ]


dw16m <- as.data.frame(table(dat.16$Crime, dat.16$month))
dwm16m <- melt(dw16m, c("Var1", "Var2"))
g.dwm16m <- dwm16m %>% group_by(Var2) %>% summarise(n = sum(value))

dg.dwm16m <- as.data.frame(g.dwm16m) 
dg.dwm16m$Var2 <- factor(dg.dwm16m$Var2, levels = month.name)
#dwm15m.s <- dwm15m[dwm15m$Var1== "Assault" | dwm15m$Var1== "Theft", ]

#pm <- ggplot(data = dwm15m, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

plot.m16 <- ggplot(data = dg.dwm16m, aes(x=Var2, y=n)) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + geom_line((aes(group = 1))) + geom_smooth((aes(group = 1)))


#2017
dat.17$date <- sapply(dat.17$Date.Time.Reported, function(x) strsplit(as.character(x), " ")[[1]][1]) %>% mdy()
dat.17$day <- weekdays(dat.17$date)
dat.17$month <- months(dat.17$date)
dat.17$quarter <- quarters(dat.17$date)
dw17 <- as.data.frame(table(dat.17$Crime, dat.17$day))
dwm17 <- melt(dw17, c("Var1", "Var2"))
dwm17.s <- dwm17[dwm17$Var1== "Assault" | dwm17$Var1== "Theft", ]


dw17m <- as.data.frame(table(dat.17$Crime, dat.17$month))
dwm17m <- melt(dw17m, c("Var1", "Var2"))
g.dwm17m <- dwm17m %>% group_by(Var2) %>% summarise(n = sum(value))

dg.dwm17m <- as.data.frame(g.dwm17m) 
dg.dwm17m <- dg.dwm17m[!dg.dwm17m$Var2=="September",]
dg.dwm17m$Var2 <- factor(dg.dwm17m$Var2, levels = month.name)
#dwm15m.s <- dwm15m[dwm15m$Var1== "Assault" | dwm15m$Var1== "Theft", ]

#pm <- ggplot(data = dwm15m, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

plot.m17 <- ggplot(data = dg.dwm17m, aes(x=Var2, y=n)) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + geom_line((aes(group = 1))) + geom_smooth((aes(group = 1)))


dw15q <- as.data.frame(table(dat.15$Crime, dat.15$quarter))

dwm15q <- melt(dw15q, c("Var1", "Var2"))

# seasons

newdat.15$num.month <- match(newdat.15$month, month.name)

newdat.15 <-
newdat.15 %>%
  mutate(Season = ifelse(num.month >= 3 & num.month <= 5, "Spring", 
                          ifelse(num.month >= 6 & num.month <= 8, "Summer",
                            ifelse(num.month >= 9 & num.month <= 11, "Autumn", "Winter"))))

dw15s <- as.data.frame(table(newdat.15$Crime, newdat.15$Season))

dwm15s <- melt(dw15s, c("Var1", "Var2"))



```

## Longitudinal plot of total crimes by month

```{r}

```

## To do
compare weekend vs. weekday cromes
compare inside vs. outside crimes
multifacet plot w/ theft and assault (longitudinal plots)
total crime count for each month

for plots - set origin to zero
relable, refactor, set stringsAsFactors = FALSE

notes for shiny options
- select crime type
- select year
- select patterns by day, month, season


```{r}

```



## Create plots
```{r}

t15 <- table(dat.15$Crime)
d15 <- as.data.frame(t15)
d15$Year <- "2015"
d15 <- d15[-1,]

dat.16 <- dat.16[!dat.16$Crime=="",]
dat.16 <- dat.16[!dat.16$Crime=="21",]
t16 <- table(dat.16$Crime)
d16 <- as.data.frame(t16)
d16$Year <- "2016"
d16 <- d16[-1:-2,]

dat.17 <- dat.17[!dat.17$Crime=="",]
dat.17 <- dat.17[!dat.17$Crime=="18",]
t17 <- table(dat.17$Crime)

d17 <- as.data.frame(t17)
d17$Year <- "2017"
d17 <- d17[-1:-2,]

total <- rbind(d15, d16)
total <- rbind(total, d17)


library(ggplot2)
#library(plotly)

p <- ggplot(data = total, aes(x=Var1, y=Freq, fill = Year)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1), plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = c(0.95, 0.85), axis.title = element_text(face = "bold")) + labs(x = "Crime Type", y = "Number of Incidents") + ggtitle("Crime Frequency by Year")

pp <- ggplotly(p) 

pp


```

## Dates
consider season, month, day of week, time

```{r}
library(lubridate)
library(dplyr)
library(reshape2)

#dat.15$day <- weekdays(as.Date(dat.15$Date.Time.Reported))
#dat.15$month <- months(as.Date(dat.15$Date.Time.Reported))
#dat.15$quarter <- quarters(as.Date(dat.15$Date.Time.Reported))

# extract time information from Date.Time.Occurred; if strsplit(as.character(x), " ")[[1]][3]  == "PM", add 12 hours except  

#dat.15$dt <- sapply(dat.15$Date.Time.Occurred, function(x) as.POSIXlt(as.character(x), format = "%m/%d/%Y %I:%M %p", tz = "UTC"))


dat.15$timehour <- sapply(dat.15$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][2]) 
dat.15$timeap <- sapply(dat.15$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][3])

dat.15$times <- paste(dat.15$timehour, dat.15$timeap)
dat.15$mtime <- substr(strptime(dat.15$times, "%I:%M %p"), 11,19)
dat.15$mtime <- trimws(dat.15$mtime)

time <- hour(hms(dat.15$mtime))
tbreaks <- hour(hm("00:00", "6:00", "12:00", "18:00", "23:59"))
tlabels <- c("Night", "Morning", "Afternoon", "Evening")
dat.15$tod <- cut(x=time, breaks = tbreaks, labels = tlabels, include.lowest = TRUE)

crime.tod.15 <- as.data.frame(table(dat.15$Crime, dat.15$tod))
crime.tod.15 <- crime.tod.15[-c(1, 15, 29, 43),]

pd <- ggplot(data = crime.tod.15, aes(x=Var1, y=Freq, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1), plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = c(0.95, 0.85), axis.title = element_text(face = "bold")) + labs(x = "Crime Type", y = "Number of Incidents") + ggtitle("Crime Frequency by Time of Day for 2015") + guides(fill = guide_legend(title = "Time of Day"))

dat.16$timehour <- sapply(dat.16$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][2]) 
dat.16$timeap <- sapply(dat.16$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][3])

dat.16$times <- paste(dat.16$timehour, dat.16$timeap)
dat.16$mtime <- substr(strptime(dat.16$times, "%I:%M %p"), 11,19)
dat.16$mtime <- trimws(dat.16$mtime)

time <- hour(hms(dat.16$mtime))
tbreaks <- hour(hm("00:00", "6:00", "12:00", "18:00", "23:59"))
tlabels <- c("Night", "Morning", "Afternoon", "Evening")
dat.16$tod <- cut(x=time, breaks = tbreaks, labels = tlabels, include.lowest = TRUE)

crime.tod.16 <- as.data.frame(table(dat.16$Crime, dat.16$tod))

dat.17$timehour <- sapply(dat.17$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][2]) 
dat.17$timeap <- sapply(dat.17$Date.Time.Occurred, function(x) strsplit(as.character(x), " ")[[1]][3])

dat.17$times <- paste(dat.17$timehour, dat.17$timeap)
dat.17$mtime <- substr(strptime(dat.17$times, "%I:%M %p"), 11,19)
dat.17$mtime <- trimws(dat.17$mtime)

time <- hour(hms(dat.17$mtime))
tbreaks <- hour(hm("00:00", "6:00", "12:00", "18:00", "23:59"))
tlabels <- c("Night", "Morning", "Afternoon", "Evening")
dat.17$tod <- cut(x=time, breaks = tbreaks, labels = tlabels, include.lowest = TRUE)

crime.tod.17 <- as.data.frame(table(dat.16$Crime, dat.16$tod))







#dat.15$timeday[dat.15$timehour]

dat.15$date <- sapply(dat.15$Date.Time.Reported, function(x) strsplit(as.character(x), " ")[[1]][1]) %>% mdy()
dat.15$day <- weekdays(dat.15$date)
dat.15$month <- months(dat.15$date)
dat.15$quarter <- quarters(dat.15$date)

dat.15 <- dat.15[-288,]

dw15 <- as.data.frame(table(dat.15$Crime, dat.15$day))

dwm15 <- melt(dw15, c("Var1", "Var2"))

dwm15.s <- dwm15[dwm15$Var1== "Assault" | dwm15$Var1== "Theft", ]

pd <- ggplot(data = dwm15, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.title=element_blank(), plot.title = element_text(hjust = 0.5, face = "bold"), axis.title = element_text(face = "bold")) + scale_fill_discrete(breaks = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")) + ggtitle("Crime Frequency by Day of Week for 2015") + labs(x = "Crime Type", y = "Number of Incidents")

pd.s <- ggplot(data = dwm15.s, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.title=element_blank(), plot.title = element_text(hjust = 0.5, face = "bold"), axis.title = element_text(face = "bold")) + scale_fill_discrete(breaks = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")) + ggtitle("Crime Frequency by Day of Week for 2015") + labs(x = "Crime Type", y = "Number of Incidents")

ppd <- ggplotly(pd) 

ppd

dw15m <- as.data.frame(table(dat.15$Crime, dat.15$month))

dwm15m <- melt(dw15m, c("Var1", "Var2"))

dwm15m.s <- dwm15m[dwm15m$Var1== "Assault" | dwm15m$Var1== "Theft", ]

#pm <- ggplot(data = dwm15m, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

pm <- ggplot(data = dwm15m, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.title=element_blank(), plot.title = element_text(hjust = 0.5, face = "bold"), axis.title = element_text(face = "bold")) + scale_fill_discrete(breaks = c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December")) + ggtitle("Crime Frequency by Month for 2015") + labs(x = "Crime Type", y = "Number of Incidents")

pm.s <- ggplot(data = dwm15m.s, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.title=element_blank(), plot.title = element_text(hjust = 0.5, face = "bold"), axis.title = element_text(face = "bold")) + scale_fill_discrete(breaks = c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December")) + ggtitle("Crime Frequency by Month for 2015") + labs(x = "Crime Type", y = "Number of Incidents")

ppm <- ggplotly(pm) 

ppm

dw15q <- as.data.frame(table(dat.15$Crime, dat.15$quarter))

dwm15q <- melt(dw15q, c("Var1", "Var2"))

pq <- ggplot(data = dwm15q, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

ppq <- ggplotly(pq) 

ppq

# seasons

newdat.15$num.month <- match(newdat.15$month, month.name)

newdat.15 <-
newdat.15 %>%
  mutate(Season = ifelse(num.month >= 3 & num.month <= 5, "Spring", 
                          ifelse(num.month >= 6 & num.month <= 8, "Summer",
                            ifelse(num.month >= 9 & num.month <= 11, "Autumn", "Winter"))))

dw15s <- as.data.frame(table(newdat.15$Crime, newdat.15$Season))

dwm15s <- melt(dw15s, c("Var1", "Var2"))

#ps <- ggplot(data = dwm15s, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1))

ps <- ggplot(data = dwm15s, aes(x=Var1, y=value, fill = Var2)) + geom_bar(stat="identity", position=position_dodge()) + theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.title=element_blank(), plot.title = element_text(hjust = 0.5, face = "bold"), axis.title = element_text(face = "bold")) + scale_fill_discrete(breaks = c("Spring", "Summer", "Autumn", "Winter")) + ggtitle("Crime Frequency by Season for 2015") + labs(x = "Crime Type", y = "Number of Incidents")

pps <- ggplotly(ps) 

pps

```
## Calendar Heatmap

plot total crime count per day
count of each crime by day
group_by day
```{r}

dat.15.total <- dat.15 %>% group_by(date) %>% tally()

dat.15.assault <- dat.15 %>% filter(Crime == "Assault")
dat.15.assault <- dat.15.assault %>% group_by(date) %>% tally()

dat.15.theft <- dat.15 %>% filter(Crime == "Theft")
dat.15.theft <- dat.15.theft %>% group_by(date) %>% tally()


dat.16.total <- dat.16 %>% group_by(date) %>% tally()

dat.17.total <- dat.17 %>% group_by(date) %>% tally()

total.yr <- rbind(dat.15.total, dat.16.total)
total.yr <- rbind(total.yr, dat.17.total)

require(RColorBrewer)
red_color_ramp = brewer.pal(9, "Reds")
ct.15 <- calendarHeat(total.yr$date, total.yr$n,
varname="Daily Crime", color="red_color_ramp")

require(RColorBrewer)
red_color_ramp = brewer.pal(9, "Reds")
ct.15 <- calendarHeat(dat.15.total$date, dat.15.total$n,
varname="Total Crime", color="red_color_ramp")


ct.16 <- calendarHeat(dat.16.total$date, dat.16.total$n,
varname="Total Crime", color="red_color_ramp")


ct.17 <- calendarHeat(dat.17.total$date, dat.17.total$n,
varname="Total Crime", color="red_color_ramp")

plot_grid(ct.15, ct.16, ct.17, labels = c("A", "B", "C"))


calendarHeat(dat.15.assault$date, dat.15.assault$n,
varname="Total Assaults", color="red_color_ramp")



calendarHeat(dat.15.theft$date, dat.15.theft$n,
varname="Total Thefts", color="red_color_ramp")


```



## Statistical Testing:
Note: just use TukeyHSD
test tod, 
day of week
hour of day
month 

```{r}

total.15 <- group_by(dat.15, tod) %>%
  summarize(
    count = n()
  )

total.16 <- group_by(dat.16, tod) %>%
  summarize(
    count = n()
  )

total.17 <- group_by(dat.17, tod) %>%
  summarize(
    count = n()
  )


total.tod <- rbind(total.15, total.16, total.17)

# what is the effect of tod on the total number of crime during that time
total.aov <- aov(count ~ tod, data = total.tod)
TH.tod <- TukeyHSD(total.aov)


# hourf (factor)

dat.15$hourf <- factor(dat.15$hours)
dat.16$hourf <- factor(dat.16$hours)
dat.17$hourf <- factor(dat.17$hours)

hours.15 <- group_by(dat.15, hourf) %>%
  summarize(
    count = n()
  )

hours.16 <- group_by(dat.16, hourf) %>%
  summarize(
    count = n()
  )

hours.17 <- group_by(dat.17, hourf) %>%
  summarize(
    count = n()
  )


total.hours <- rbind(hours.15, hours.16, hours.17)

# what is the effect of tod on the total number of crime during that time
hours.aov <- aov(count ~ hourf, data = total.hours)
TH.hours <- TukeyHSD(hours.aov)



# day

day.15 <- group_by(dat.15, day) %>%
  summarize(
    count = n()
  )

day.16 <- group_by(dat.16, day) %>%
  summarize(
    count = n()
  )

day.17 <- group_by(dat.17, day) %>%
  summarize(
    count = n()
  )


total.day <- rbind(day.15, day.16, day.17)

# what is the effect of tod on the total number of crime during that time
day.aov <- aov(count ~ day, data = total.day)
TH.day <- TukeyHSD(day.aov)









dat.15.theft <- filter(dat.15, dat.15$Crime == "Theft")
dat.16.theft <- filter(dat.16, dat.16$Crime == "Theft")
dat.17.theft <- filter(dat.17, dat.17$Crime == "Theft")

test.15 <- group_by(dat.15.theft, tod) %>%
  summarize(
    count = n()
  )

test.16 <- group_by(dat.16.theft, tod) %>%
  summarize(
    count = n()
  )

test.17 <- group_by(dat.17.theft, tod) %>%
  summarize(
    count = n()
  )

# NA values
test.16 <- test.16[1:4,]
test.17 <- test.17[1:4,]

test <- rbind(test.15, test.16, test.17)

# what is the effect of tod on the total number of crime during that time
test.aov <- aov(count ~ tod, data = test)
TH <- TukeyHSD(test.aov)
pt <- pairwise.t.test(test$count, test$tod)

print(xtable(TH$tod))

print(xtable(pt$p.value))

plotTukeyHSD <- plotTukeysHSD <- function(tukey.out,
                           x.axis.label = "Comparison",
                           y.axis.label = "Effect Size",
                       axis.adjust = 0,
                       adjust.x.spacing = 5){
  
  tukey.out <- as.data.frame(tukey.out[[1]])
  means <- tukey.out$diff
  categories <- row.names(tukey.out)
  groups <- length(categories)
  ci.low <- tukey.out$lwr
  ci.up  <- tukey.out$upr                         
  
  n.means <- length(means)
   
  #determine where to plot points along x-axis
  x.values <- 1:n.means
  x.values <- x.values/adjust.x.spacing
  
                             
  # calculate values for plotting limits            
  y.max <- max(ci.up) +                    
    max(ci.up)*axis.adjust
  y.min <- min(ci.low) - 
    max(ci.low)*axis.adjust
  
  if(groups == 2){ x.values <- c(0.25, 0.5)}
  if(groups == 3){ x.values <- c(0.25, 0.5,0.75)}
  
  x.axis.min <- min(x.values)-0.05
  x.axis.max <- max(x.values)+0.05
  
  x.limits <- c(x.axis.min,x.axis.max)
  
  #Plot means
  plot(means ~ x.values,
       xlim = x.limits,
       ylim = c(y.min,y.max),
       xaxt = "n",
       xlab = "",
       ylab = "",
       cex = 1.25,
       pch = 16)
  
  axis(side = 1, 
       at = x.values,
       labels = categories
      )
  
  #Plot upper error bar 
  lwd. <- 2
  arrows(y0 = means,
         x0 = x.values,
         y1 = ci.up,
         x1 = x.values,
         length = 0,
         lwd = lwd.)
  
  #Plot lower error bar
  arrows(y0 = means,
         x0 = x.values,
         y1 = ci.low,
         x1 = x.values,
         length = 0,
         lwd = lwd.) 
  
  #add reference line at 0
  abline(h = 0, col = 2, lwd = 2, lty =2)
  
  #mtext(text = x.axis.label,side = 1,line = 1.75)
  mtext(text = y.axis.label,side = 2,line = 1.95)
  # Error bars = 95% CI
  # mtext(text = "Effect Size of Time of Day on Total Crime",side = 3,line = 1)
  mtext(text = "Effect Size of Day of Week on Total Crime",side = 3,line = 1)
  
}      


p.TH.tod <- plotTukeyHSD(TH.tod)
plotTukeyHSD(TH.day)

```



## Location
Need to do text processing of general locations (buildings, areas)
155 unique locations 
look at groupings of general areas
look at correlations of crime types, time and areas
```{r}
t.15 <- table(dat.15$General.Location)
d.15 <- as.data.frame(t.15)

library("dataframes2xls")
write.xls(d.15, "locationlist.xls")

write.xls(d.15, "locationtest.xls", quote = FALSE)

library("stringr")
d.15$outside <- str_detect(d.15$Var1, "block")

dat.15$outside <- str_detect(dat.15$General.Location, "block")

```

## Geocode Locations
```{r}
jh.map <- qmap("johns hopkins hospital", zoom = 14)

jh.map + geom_point(aes(x=lon, y=lat, colour = name), data = h.df) + ggtitle("Map of Crime at the Johns Hopkins East Baltimore Medical Campus")


h.df <- geocode(c("1550 Orleans St, Baltimore", "1800 Orleans St, Baltimore"))
h.df$name <- c("CRB", "Main Hospital")
g.loc <- paste(h.df$lat, h.df$lon, sep = ":")
m.google <- data.frame(h.df, g.loc)
g.inter.map <- gvisMap(data = m.google, locationvar = "g.loc", tipvar = "name")
plot(g.inter.map)


# cite: http://www.storybench.org/geocode-csv-addresses-r/
setwd("/Users/purplesw/Dropbox/final_project/data")
origAddress <- read.csv("location.csv", stringsAsFactors = FALSE)

a.df <- as.data.frame(table(origAddress$addresses))

for(i in 1:nrow(a.df)){
  temp <- geocode(as.character(a.df$Var1[i]))
  a.df$lon[i] <- temp$lon
  a.df$lat[i] <- temp$lat
  Sys.sleep(2)
}


geocoded <- data.frame(stringsAsFactors = FALSE)

# Loop through the addresses to get the latitude and longitude of each address and add it to the
# origAddress data frame in new columns lat and lon
for(i in 1:nrow(origAddress))
{
  # Print("Working...")
  result <- geocode(origAddress$addresses[i], output = "latlona", source = "google")
  origAddress$lon[i] <- as.numeric(result[1])
  origAddress$lat[i] <- as.numeric(result[2])
  origAddress$geoAddress[i] <- as.character(result[3])
  Sys.sleep(2)
}
# Write a CSV file containing origAddress to the working directory
write.csv(origAddress, "geocoded.csv", row.names=FALSE)
write.csv(a.df, "uniquegeocode.csv", row.names=FALSE)

#setwd("/Users/purplesw/Dropbox/final_project/code")
g.df <- read.csv("uniquegeocode.csv", stringsAsFactors = FALSE)

colnames(g.df)[1] <- "addresses"
geo.loc <- left_join(origAddress, g.df, by  = "addresses")

dat.15.a <- dat.15
colnames(dat.15.a)[5] <- "Var1"

for(i in 1:nrow(geo.loc)){
  geo.loc$Var1[i] <- noquote(geo.loc$Var1[i])
}


geo.loc.t <- left_join(dat.15.a, geo.loc, by = "Var1")



geo.loc.t.df <- as.data.frame(table(geo.loc.t$addresses))

colnames(geo.loc.t.df)[1] <- "addresses"

g.df.t <- left_join(geo.loc.t.df, g.df, by = "addresses")

plot(g.df$lon, g.df$lat, xlab = "longitude", ylab = "latitude", main = "Longitude and Latitude of Crime Locations")

jhu.map <- qmap("johns hopkins hospital", zoom = 16)
jhu.map + geom_point(aes(x = lon, y = lat, colour = factor(Freq)), size = 2, data = g.df)

jhu.1 + geom_point(aes(x = lon, y = lat, colour = factor(Freq.x)), size = 2, data = g.df.t)


jhu.1 + geom_point(aes(x = lon, y = lat, colour = factor(Freq)), size = 3, data = g.df) + scale_fill_discrete(name = "Crime Incidents \nat Each Location")

#plot(g.df$lon, g.df$lat, xlab = "lon", ylab = "lat", xlim = c(-76.59734, -76.5), ylim = c(39.2, 39.3))
```

## create tables
```{r}
library(xtable)
options(xtable.floating = FALSE)

c.types.15 <- table(dat.15$Crime)

x.c.types.15 <- xtable(c.types.15)
print(xtable(c.types.15, caption = "Crime Types and Frequency"), caption.placement = "top")

c.types.16 <- table(dat.16$Crime)
print(xtable(c.types.16))

c.types.17 <- table(dat.17$Crime)
print(xtable(c.types.17))


```



## To Do
- parse time of day from "Date.Time.Occurred"
- rearrange labels for plots
- add title and axis lables to plots

Analysis 
- crimes by location
- crimes by inside/outside
- crimes inside/outside by time of day
- crimes inside/outside by season


```{r}
ui <- shinyUI(
  
  
  navbarPage("Hopkins Crime Statistics",
             theme = "style.css", 
             # includeCSS("map.css"),
             
             ## Sidebar content
             tabPanel("Crime Trends",
                      sidebarLayout(
                        sidebarPanel(
                          # menuItem("Widgets", tabName = "widgets", icon = icon("th")),
                          selectInput("crime.type", "Crime Description", 
                                      choices = crime.type, selected = crime.type[7]),
                          checkboxGroupInput("year", label = "Year",
                                             choices = unique.years,
                                             selected = tail(unique.years,2), 
                                             inline = T)
                        ),
                        mainPanel( 
                          fluidRow(column(plotOutput("plot1"), width = 11)),
                          fluidRow(column(includeMarkdown('references.Rmd'), width = 11))
                        )
                      )
             ),
             tabPanel("Map",
                      sidebarLayout(
                        sidebarPanel(
                          selectInput("crime.type.map", "Crime Description", 
                                      choices = crime.type, selected = crime.type[1]),
                          selectInput("year.map", "Year",
                                      choices = unique.years, selected = unique.years[1])
                        ),
                        mainPanel( 
                          fluidRow(column(leafletOutput("mymap"), width = 11)),
                          fluidRow(column(includeMarkdown('references.Rmd'), width = 11))
                        )
                      )
             )
             
  )
)
```



